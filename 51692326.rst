================================================================
Sphinxで日本語を含むWindowsヘルプを作成するのに大変だった件。
================================================================

  :URL: http://blog.livedoor.jp/lab1092/archives/51692326.html

まだきちんと内容の検証なども出来ていないけれど、とりあえずSphinxから.chm作成の際の目次と検索の文字化けについて対処できたっ *ぽい* のでー。

   出力フォーマット: HTML( *Windows HTMLヘルプも含む* )、LaTeX(印刷可能なPDF)、manページ、プレーンテキスト ... 


この文言が目に入らなかったら、某所のWebサーバーがIISからTomcatにならなかったら手を出してはいなかったかもしれませんｗｗｗ。

どちらにしろ、Windows環境なので、大きなファイルを１つどこかに置いておいてもいいかな、と。


この時点でSphinxからHTMLとPDFに変換する、ということは自身で出来る状態になっていたので、

   make htmlhelp

で.chmファイル作れるのかと期待していたわけですよ。そんなことはまったく無かったんですね。.chm形式のファイルを作るために「コンパイル」という作業がさらに必要なんですね。Sphinxは元ファイルとインデックスを生成するのみ。

それがわかったので、ここはgoogle先生に。こんな感じで検索してました。

   検索 - "Windows Help コンパイル chm"

そしてこことか、こことか見て、「ああ、"HTML Help Workshop"っていうツールが必要なんだな」ということがわかりました(ツール単体はこちらから入手可能)。

もちろん、HTML Help Workshopをセットアップして、.chmファイルの作成をして、目次を見てみると日本語の部分が見事に文字化けしていました。

まあ、.chmファイル作成の際に文字化けする、というのは調査の過程でプロジェクトのフォント設定がどうこう、というものがあったので、HTML Help Workshopの画面から、それぞれのフォント設定を"MS UIゴシック、日本語"として設定を変更および保存。

そしてコンパイルして出来た.chmファイルを開くと…目次のツリーの項目が見事に文字化けしていました。少しファイルを眺めた結果、

   _build\htmlhelp\helpfile.hhc

のインデックスがどうやら文字化けの原因になっていそうだったので、"&#xxxxxx;"になっている部分をShift-JISコードにするためのコードを書いてみたり。

.. code-block :: python

   import re

   p= re.compile(r'\&\#(\d*)\;')

   # def
   def foo(match):
       n = int(match.groups(0)[0])
       try:
           s = unichr(n).encode('shift-jis')
       except:
           s= "?"
       return s

   # これをくるくる回すかんじ("line"が入力文字列,foが出力ファイル)
   print >>fo,p.sub(foo,line)


とりあえずこの時点で変換したあとのhelpfile.hhcを含めたファイルから.chmファイルを作成、目次を確認してみて、文字化けが無いことを確認できました。やった。

と喜んだのもつかの間、検索機能で検索結果リストに表示される日本語文字列がことごとく…。
HTMLファイルすべて、上と同じ処理+metaヘッダのエンコード指定の箇所を変更することに。

.. code-block :: python

    line = line.replace('content="text/html; charset=iso8859_1"','content="text/html; charset=shift-jis"')

まとめると、

   * Sphinxで"make htmlhelp"でWindowsヘルプ作成のための種となるファイル群が生成される。
   * .chmのファイルにするには、"HTML Help Workshop"というツールでコンパイルが必要。
   * 用意するHTMLファイルおよび目次ファイルは日本語の場合SJISの模様。
   * Sphinxが吐き出したのは"iso8859_1"でエンコードされたファイル。
   * WindowsHelpのコンパイル時にエンコードをSJISにそろえる必要あり(上記のような変換が必要)。
   * HTML Help Workshopでプロジェクトファイルを開いたあとに、各所のフォント設定を行って、日本語フォントを指定しておくほうが良い?

という感じでしょうかね。

まあ、"conf.py"に Windowsヘルプ生成時の言語オプションとか指定できてもよさそうなんだけど、調べるの面倒なので、上記のような方法で。

もちろん、".. blockdiag ::"な表記のものもちゃーんと表示されてますよっと。

とまあ、ここまできて梅.pyを思い出してみると…あっ。ということでおしまい。

[EDIT]上記では根本的に対処できてませんｗｗｗ





